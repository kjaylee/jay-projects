# ⚔️ 삼국지 패왕전 - 상세 개발 설계서 v2

> **멀티플레이어 설계** | Supabase + Cloudflare
> 133개 세부 태스크 | 예상 총 개발 기간: 12주

---

## 🏗️ 아키텍처

```
┌─────────────────────────────────────────────┐
│          클라이언트 (HTML5/Phaser 3)         │
│            Cloudflare Pages 호스팅           │
└─────────────────┬───────────────────────────┘
                  │ HTTPS
┌─────────────────▼───────────────────────────┐
│              Supabase (BaaS)                │
├─────────────────────────────────────────────┤
│  🔐 Auth      - Google/Apple/Guest 로그인   │
│  🗄️ PostgreSQL - 유저, 장수, 전투 데이터     │
│  ⚡ Realtime   - PvP 실시간, 랭킹 동기화     │
│  📁 Storage   - 장수 일러스트, 이펙트        │
│  🔧 Edge Fn   - 가챠, 전투검증, 보상계산     │
└─────────────────────────────────────────────┘
```

---

## 📋 태스크 분류 (133개)

| 카테고리 | 태스크 수 | 예상 시간 |
|----------|----------|----------|
| 🏗️ 프로젝트 셋업 | 10개 | 5h |
| 🗄️ Supabase 셋업 | 12개 | 8h |
| 📊 데이터 설계 | 12개 | 8h |
| 👤 장수 시스템 | 15개 | 20h |
| ⚔️ 전투 시스템 | 18개 | 32h |
| 🗺️ 스테이지/맵 | 10개 | 12h |
| 💤 방치 시스템 | 8개 | 10h |
| 🎰 가챠/상점 | 10개 | 12h |
| 🏟️ PvP 시스템 | 10개 | 16h |
| 🎨 UI/UX | 12개 | 16h |
| 🔊 사운드/이펙트 | 5개 | 6h |
| 🔐 보안/치팅방지 | 5개 | 6h |
| 🧪 테스트/QA | 6개 | 8h |
| **합계** | **133개** | **159h** |

---

## 🏗️ Phase 1: 프로젝트 셋업 (10 Tasks)

| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 001 | 프로젝트 폴더 구조 생성 | `/src`, `/assets`, `/data`, `/supabase` | 15m |
| 002 | package.json 초기화 | Phaser 3, @supabase/supabase-js | 15m |
| 003 | Vite 번들러 설정 | dev server, env 변수 | 30m |
| 004 | Phaser 3 보일러플레이트 | Game config, Scene 구조 | 30m |
| 005 | Supabase 클라이언트 초기화 | createClient, 환경변수 | 30m |
| 006 | TypeScript 설정 | 타입 자동생성 연동 | 30m |
| 007 | ESLint + Prettier 설정 | 코드 스타일 통일 | 15m |
| 008 | Git 브랜치 전략 수립 | main/dev/feature 구조 | 15m |
| 009 | Cloudflare Pages 배포 | 자동 배포 파이프라인 | 30m |
| 010 | README 작성 | 설치/실행/환경변수 가이드 | 15m |

---

## 🗄️ Phase 2: Supabase 셋업 (12 Tasks)

### 2.1 프로젝트 생성
| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 011 | Supabase 프로젝트 생성 | 리전: Northeast Asia | 15m |
| 012 | 환경변수 설정 | SUPABASE_URL, ANON_KEY | 15m |
| 013 | Auth 프로바이더 설정 | Google, Apple, Guest | 30m |

### 2.2 DB 스키마
| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 014 | users 테이블 | id, nickname, level, gold, gems, vip, stamina | 30m |
| 015 | generals 테이블 (마스터) | id, name, grade, class, base_stats, skills | 30m |
| 016 | user_generals 테이블 | user_id, general_id, level, stars, exp, equipment | 30m |
| 017 | formations 테이블 | user_id, slot, positions[9], is_active | 30m |
| 018 | stages 테이블 (마스터) | id, chapter, enemies, rewards, requirements | 30m |
| 019 | user_stages 테이블 | user_id, stage_id, stars, best_time | 30m |
| 020 | battles 테이블 | id, attacker_id, defender_id, winner, replay | 30m |
| 021 | idle_rewards 테이블 | user_id, last_claim_at, accumulated | 30m |
| 022 | gacha_history 테이블 | user_id, banner_id, result, pity_count | 30m |

### 2.3 보안 정책
| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 023 | RLS 정책: users | 본인 데이터만 읽기/쓰기 | 30m |
| 024 | RLS 정책: user_generals | 본인만 수정, 타인 읽기 가능 (PvP) | 30m |
| 025 | RLS 정책: battles | 참여자만 읽기 | 30m |

---

## 📊 Phase 3: 데이터 설계 (12 Tasks)

### 3.1 장수 데이터
| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 026 | 장수 50명 데이터 작성 | N 20, R 15, SR 10, SSR 4, UR 1 | 2h |
| 027 | 장수 성장 공식 설계 | 레벨별 스탯 = base * (1 + level * 0.1) | 30m |
| 028 | 승급 요구사항 테이블 | ★1~★5 필요 재료/골드 | 30m |

### 3.2 스킬/계략 데이터
| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 029 | 계략 30종 설계 | 공격 10, 디버프 8, 버프 7, 회복 5 | 1h |
| 030 | 패시브 스킬 20종 설계 | 조건부 버프, 시너지 효과 | 1h |

### 3.3 게임 밸런스
| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 031 | 데미지 공식 설계 | ATK * (1 - DEF/(DEF+100)) | 30m |
| 032 | 계략 데미지 공식 | INT * multiplier * (1 - RES/(RES+80)) | 30m |
| 033 | 스테이지 난이도 곡선 | 적 스탯 = base * (1.15 ^ stage) | 30m |
| 034 | 경험치/골드 드랍 테이블 | 스테이지별 보상 | 30m |
| 035 | 가챠 확률 테이블 | N 60%, R 30%, SR 8%, SSR 1.8%, UR 0.2% | 15m |
| 036 | 방치 보상 공식 | gold/min = 정치합 * 0.5, exp/min = stage * 2 | 30m |
| 037 | 천장 시스템 설계 | 80회 SSR 보장, 160회 픽업 보장 | 15m |

---

## 👤 Phase 4: 장수 시스템 (15 Tasks)

### 4.1 코어 클래스
| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 038 | General 클래스 | 속성, 스탯 계산 메서드 | 1h |
| 039 | GeneralStats 클래스 | 5대 스탯 + 버프 계산 | 30m |
| 040 | Skill 클래스 | 발동 조건, 효과 처리 | 1h |
| 041 | Equipment 클래스 | 장비 슬롯, 스탯 보너스 | 30m |

### 4.2 Supabase 연동
| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 042 | GeneralService | fetchUserGenerals, updateGeneral | 1h |
| 043 | 장수 획득 (서버) | Edge Function: grantGeneral | 1h |
| 044 | 장수 레벨업 (서버) | Edge Function: levelUpGeneral | 1h |
| 045 | 장수 승급 (서버) | Edge Function: upgradeGeneral | 1h |

### 4.3 장수 UI
| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 046 | 장수 목록 화면 | 그리드 뷰, 필터/정렬 | 2h |
| 047 | 장수 상세 화면 | 스탯, 스킬, 장비 표시 | 2h |
| 048 | 장수 레벨업 UI | 경험치 바, 확인 팝업 | 1h |
| 049 | 장수 승급 UI | 재료 선택, 합성 연출 | 1h |
| 050 | 장수 일러스트 로드 | Supabase Storage CDN | 30m |
| 051 | 장수 등급 이펙트 | SSR/UR 획득 시 연출 | 1h |
| 052 | 장수 필터링 | 등급, 클래스, 세력별 | 30m |

---

## ⚔️ Phase 5: 전투 시스템 (18 Tasks)

### 5.1 전투 코어
| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 053 | BattleScene 생성 | Phaser Scene 기본 구조 | 1h |
| 054 | BattleManager 클래스 | 전투 상태 머신 | 2h |
| 055 | 턴 순서 계산 | 속도 기반 우선순위 큐 | 30m |
| 056 | 타겟팅 시스템 | 전열 우선, 도발, 랜덤 | 1h |
| 057 | DamageCalculator | 공식 적용, 크리티컬, 회피 | 1h |
| 058 | BattleValidator (서버) | Edge Function: 결과 검증 | 2h |

### 5.2 진형 시스템
| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 059 | Formation 클래스 | 3x3 그리드 데이터 | 30m |
| 060 | 진형 배치 UI | 드래그 앤 드롭 | 2h |
| 061 | 진형 저장 (서버) | Supabase formations 테이블 | 30m |
| 062 | 진형 시너지 계산 | 세력/클래스 버프 | 1h |
| 063 | 진형 추천 AI | 자동 최적 배치 | 1h |

### 5.3 스킬 실행
| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 064 | SkillExecutor 클래스 | 스킬 실행 파이프라인 | 2h |
| 065 | 단일/범위 타겟 스킬 | 전체, 종렬, 횡렬 | 1h |
| 066 | 버프/디버프 시스템 | 지속시간, 중첩, 해제 | 1h |
| 067 | 회복/부활 스킬 | HP 회복, 쓰러진 장수 부활 | 30m |

### 5.4 전투 연출
| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 068 | 유닛 스프라이트 배치 | 아군 좌측, 적군 우측 | 1h |
| 069 | 공격 애니메이션 | 돌진, 타격, 복귀 | 2h |
| 070 | 스킬 이펙트 5종 | 화계, 수계, 낙석, 버프, 회복 | 3h |
| 071 | 데미지 숫자 팝업 | 크리티컬 강조, 색상 구분 | 30m |
| 072 | HP바 UI | 실시간 감소 트윈 | 30m |
| 073 | 승리/패배 연출 | 결과 화면, 보상 표시 | 1h |

---

## 🗺️ Phase 6: 스테이지 (10 Tasks)

| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 074 | 스테이지 30개 설계 | 챕터 1~3, 각 10스테이지 | 1h |
| 075 | StageService | fetchStages, updateProgress | 1h |
| 076 | 스테이지 선택 UI | 챕터별 맵 뷰, 별점 표시 | 2h |
| 077 | 보스 3종 설계 | 동탁, 여포, 조조 (특수 패턴) | 1h |
| 078 | Boss 클래스 | 페이즈 전환, 특수 스킬 | 2h |
| 079 | 보스 연출 | 등장 컷신, 대사 | 1h |
| 080 | RewardService (서버) | Edge Function: 보상 지급 | 1h |
| 081 | 클리어 보상 UI | 획득 아이템 연출 | 1h |
| 082 | 별점 시스템 | 1~3성 조건 (턴, 생존) | 30m |
| 083 | 스테이지 잠금 해제 | 이전 스테이지 클리어 조건 | 30m |

---

## 💤 Phase 7: 방치 시스템 (8 Tasks)

| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 084 | IdleService (서버) | Edge Function: calculateIdleRewards | 2h |
| 085 | 마지막 접속 시간 저장 | Supabase idle_rewards 테이블 | 30m |
| 086 | 오프라인 보상 계산 | 시간당 골드/경험치 | 1h |
| 087 | 오프라인 보상 팝업 | 접속 시 보상 표시 | 1h |
| 088 | 최대 누적 시간 제한 | 12시간 캡 | 30m |
| 089 | AutoBattle 모드 | 스테이지 반복 (클라이언트) | 2h |
| 090 | 배속 기능 | 1x, 2x, 4x 전투 속도 | 1h |
| 091 | 스킵 기능 | 전투 결과만 표시 | 1h |

---

## 🎰 Phase 8: 가챠/상점 (10 Tasks)

| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 092 | GachaService (서버) | Edge Function: pullGacha | 2h |
| 093 | 천장 카운터 | pity_count 추적 | 30m |
| 094 | 단차/10연차 | 10연차 SR 보장 로직 | 1h |
| 095 | 가챠 연출 | 뽑기 애니메이션, 등급별 | 2h |
| 096 | 가챠 배너 UI | 픽업 장수, 확률 표시 | 1h |
| 097 | ShopService (서버) | Edge Function: purchaseItem | 1h |
| 098 | 재화 상점 UI | 보석, 골드 패키지 | 1h |
| 099 | 일일 상점 | 매일 리셋, 할인 상품 | 1h |
| 100 | 구매 확인 팝업 | 재화 부족 처리 | 30m |
| 101 | 구매 내역 로깅 | 결제 추적용 | 30m |

---

## 🏟️ Phase 9: PvP 시스템 (10 Tasks)

| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 102 | PvP 매칭 (서버) | Edge Function: findOpponent | 2h |
| 103 | 상대 진형 조회 | RLS로 타인 formations 읽기 | 30m |
| 104 | PvP 전투 실행 | 클라이언트 시뮬레이션 | 2h |
| 105 | 전투 결과 검증 (서버) | Edge Function: validatePvpResult | 2h |
| 106 | 랭킹 시스템 | Supabase View + 실시간 구독 | 2h |
| 107 | 랭킹 UI | 순위, 점수, 보상 표시 | 1h |
| 108 | 시즌 리셋 | 주간/월간 리셋 로직 | 1h |
| 109 | PvP 보상 (서버) | Edge Function: claimPvpReward | 1h |
| 110 | 전투 리플레이 저장 | battles.replay JSONB | 1h |
| 111 | 리플레이 재생 | 저장된 전투 다시보기 | 2h |

---

## 🎨 Phase 10: UI/UX (12 Tasks)

| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 112 | 메인 로비 Scene | 배경, 캐릭터, 퀵메뉴 | 2h |
| 113 | 상단 자원 바 | 골드, 보석, 스태미나 | 1h |
| 114 | 하단 네비게이션 | 5개 탭 전환 | 1h |
| 115 | 팝업 매니저 | 모달 스택 관리 | 1h |
| 116 | 토스트 메시지 | 획득/에러 알림 | 30m |
| 117 | 로딩 화면 | 프로그레스 바 | 30m |
| 118 | 로그인 화면 | 소셜 로그인 버튼 | 1h |
| 119 | 닉네임 설정 | 최초 접속 시 | 30m |
| 120 | 화면 전환 효과 | 페이드, 슬라이드 | 1h |
| 121 | 튜토리얼 시스템 | 하이라이트, 가이드 | 2h |
| 122 | 설정 화면 | 사운드, 계정연동, 로그아웃 | 1h |
| 123 | 반응형 레이아웃 | 모바일/태블릿 대응 | 2h |

---

## 🔊 Phase 11: 사운드 (5 Tasks)

| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 124 | SoundManager 클래스 | Howler.js 래퍼 | 1h |
| 125 | BGM 3종 적용 | 로비, 전투, 보스 | 1h |
| 126 | SFX 10종 적용 | 타격, 스킬, UI | 1h |
| 127 | 볼륨 컨트롤 | BGM/SFX 개별 조절 | 30m |
| 128 | 무료 에셋 수집 | OpenGameArt, Freesound | 1h |

---

## 🔐 Phase 12: 보안 (5 Tasks)

| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 129 | RLS 전체 검증 | 모든 테이블 정책 테스트 | 1h |
| 130 | 재화 조작 방지 | 서버에서만 재화 변경 | 1h |
| 131 | 전투 결과 검증 | 서버 시뮬레이션 비교 | 2h |
| 132 | Rate Limiting | 가챠, 전투 요청 제한 | 1h |
| 133 | 로깅/모니터링 | 의심 행위 기록 | 1h |

---

## 🧪 Phase 13: 테스트/QA (6 Tasks)

| # | 태스크 | 상세 | 시간 |
|---|--------|------|------|
| 134 | 유닛 테스트 | 데미지 계산, 가챠 확률 | 2h |
| 135 | 전투 시뮬레이터 | 1000회 자동 전투 밸런스 | 2h |
| 136 | E2E 테스트 | 가입→가챠→전투→PvP | 2h |
| 137 | 모바일 테스트 | 터치, 해상도 대응 | 1h |
| 138 | 성능 최적화 | 메모리 누수, FPS | 1h |
| 139 | 베타 테스트 | 10명 피드백 수집 | 1h |

---

## 📅 개발 일정 (12주)

| 주차 | Phase | 마일스톤 |
|------|-------|----------|
| 1 | 1, 2 | 프로젝트 + Supabase 셋업 완료 |
| 2 | 3, 4 | 데이터 + 장수 시스템 |
| 3-4 | 5 | 전투 시스템 완료 |
| 5 | 6 | 스테이지 완료 |
| 6 | 7 | 방치 시스템 완료 |
| 7 | 8 | 가챠/상점 완료 |
| 8-9 | 9 | PvP 시스템 완료 |
| 10 | 10, 11 | UI/사운드 완료 |
| 11 | 12 | 보안 검증 |
| 12 | 13 | QA + 런칭 |

---

## 🎯 자동 구현 태스크 순서

### Sprint 1 (태스크 001-025)
```
프로젝트 셋업 → Supabase 셋업 → DB 스키마 → RLS 정책
```

### Sprint 2 (태스크 026-052)
```
장수 데이터 → 장수 클래스 → 장수 서비스 → 장수 UI
```

### Sprint 3 (태스크 053-073)
```
전투 코어 → 진형 시스템 → 스킬 실행 → 전투 연출
```

### Sprint 4 (태스크 074-091)
```
스테이지 → 보스 → 방치 시스템
```

### Sprint 5 (태스크 092-111)
```
가챠 → 상점 → PvP → 랭킹
```

### Sprint 6 (태스크 112-139)
```
UI → 사운드 → 보안 → QA
```

---

## 📂 폴더 구조

```
/three-kingdoms-warlord
├── /src
│   ├── /scenes
│   │   ├── BootScene.ts
│   │   ├── PreloadScene.ts
│   │   ├── LoginScene.ts
│   │   ├── MainScene.ts
│   │   ├── BattleScene.ts
│   │   ├── GachaScene.ts
│   │   └── PvpScene.ts
│   ├── /services
│   │   ├── SupabaseClient.ts
│   │   ├── AuthService.ts
│   │   ├── GeneralService.ts
│   │   ├── BattleService.ts
│   │   ├── StageService.ts
│   │   ├── GachaService.ts
│   │   ├── PvpService.ts
│   │   └── IdleService.ts
│   ├── /entities
│   │   ├── General.ts
│   │   ├── Skill.ts
│   │   ├── Formation.ts
│   │   └── Stage.ts
│   ├── /managers
│   │   ├── GameManager.ts
│   │   ├── BattleManager.ts
│   │   └── SoundManager.ts
│   ├── /ui
│   │   ├── /components
│   │   └── /popups
│   └── /utils
│       ├── Calculator.ts
│       └── Constants.ts
├── /supabase
│   ├── /migrations
│   │   └── 001_initial_schema.sql
│   └── /functions
│       ├── gacha/index.ts
│       ├── battle-validate/index.ts
│       ├── idle-reward/index.ts
│       └── pvp-match/index.ts
├── /assets
│   ├── /images
│   ├── /audio
│   └── /data
├── package.json
├── vite.config.ts
├── tsconfig.json
└── README.md
```

---

## 💰 예상 비용

| 단계 | DAU | Supabase | Cloudflare | 합계 |
|------|-----|----------|------------|------|
| MVP | ~100 | $0 | $0 | **$0** |
| 알파 | ~300 | $0 | $0 | **$0** |
| 베타 | ~1K | $25 | $0 | **$25/월** |
| 런칭 | ~5K | $75 | $5 | **$80/월** |

---

*상세 설계 v2: 미스 김 | 2026.01.28*
*멀티플레이어 Supabase 아키텍처*
*총 139개 태스크 | 예상 159시간*
