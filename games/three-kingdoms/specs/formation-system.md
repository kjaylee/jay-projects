# 진형 배치 시스템 스펙 (Formation System)

## 1. 현재 구현 상태

### ✅ 완료된 기능

#### Formation 클래스 (`src/entities/Formation.ts`)
- **3x3 그리드 구조**
  - 행(row): 0=전열, 1=중열, 2=후열
  - 열(col): 0=좌, 1=중, 2=우
  - 최대 9명 배치 가능

- **배치 관리**
  - `placeUnit(generalId, row, col)`: 유닛 배치
  - `removeUnit(row, col)`: 유닛 제거
  - `moveUnit(from, to)`: 유닛 이동 (빈 칸 이동 또는 스왑)
  - `getUnitAt(row, col)`: 특정 위치 유닛 조회

- **조회 기능**
  - `getRow(row)`: 특정 행의 모든 유닛
  - `getColumn(col)`: 특정 열의 모든 유닛
  - `getAllUnits()`: 모든 유닛 목록
  - `getUnitCount()`: 배치된 유닛 수
  - `hasUnit(generalId)`: 특정 장수 존재 여부

- **검증**
  - `isValid()`: 최소 1명 이상 배치 여부
  - `isFull()`: 9명 전원 배치 여부
  - 범위 검사 (0-2)
  - 중복 배치 방지 (같은 장수, 같은 위치)

#### 시너지 시스템
- **세력 시너지**: 같은 세력 3명 이상 → 공격력 +10%
- **클래스 시너지**: 같은 클래스 3명 이상 → 클래스 보너스 +10%
- `calculateSynergy(factions, classes)`: 시너지 계산

#### 직렬화
- `toJSON()`: `{ userId, positions[] }` 형태
- `fromJSON()`: JSON에서 복원

### 🧪 테스트 커버리지 (`tests/unit/Formation.test.ts`)
- [x] 빈 진형 생성
- [x] 기존 배치로 생성
- [x] 유닛 배치 성공
- [x] 같은 위치 중복 배치 불가
- [x] 범위 밖 배치 불가
- [x] 같은 장수 중복 배치 불가
- [x] 유닛 제거
- [x] 빈 위치로 이동
- [x] 점유된 위치로 이동 (스왑)
- [x] 전열/종렬 조회
- [x] 최대 9명 배치
- [x] 빈 진형 유효성
- [x] 세력 시너지 (3명 +10%)
- [x] 클래스 시너지
- [x] JSON 직렬화/역직렬화

---

## 2. 남은 요구사항

### ✅ 구현된 기능

| 기능 | 기획서 요구사항 | 상태 |
|------|----------------|------|
| **진형 UI** | 드래그앤드롭 배치 | ✅ 완료 (클릭 기반) |
| **진형 저장** | DB/LocalStorage 저장 | ✅ 완료 |
| **다중 진형 슬롯** | 여러 진형 프리셋 저장 | ✅ 완료 (5슬롯) |

### ❌ 미구현 기능

| 기능 | 기획서 요구사항 | 상태 |
|------|----------------|------|
| **추천 진형** | AI 기반 추천 | 미구현 |
| **클래스별 배치 제한** | 맹장=전열, 책사=후열 등 | 미구현 |
| **시너지 상세화** | 2/3/4/5명 단계별 보너스 | 3명 단일 기준만 존재 |

### 📋 기획서 진형 배치 규칙

```
[후열] 📜 책사  🏹 궁장  📜 책사
[중열] ⚔️ 기장  🗡️ 맹장  ⚔️ 기장  
[전열] 🛡️ 방장  🗡️ 맹장  🛡️ 방장
```

**클래스별 권장 배치:**
| 클래스 | 역할 | 권장 배치 |
|--------|------|----------|
| 🗡️ 맹장 | 물리 딜러 | 전열/중열 |
| 🛡️ 방장 | 탱커 | 전열 |
| 🏹 궁장 | 원거리 딜러 | 후열 |
| 📜 책사 | 계략/지원 | 후열 |
| ⚔️ 기장 | 기병 돌격 | 중열 |

---

## 3. 수용 기준 (Acceptance Criteria)

### AC-FRM-01: 진형 생성
```
GIVEN 유저 ID가 주어졌을 때
WHEN 새 진형을 생성하면
THEN 빈 3x3 그리드가 생성된다
```
**상태: ✅ 완료**

### AC-FRM-02: 유닛 배치
```
GIVEN 빈 위치가 있을 때
WHEN 유닛을 배치하면
THEN 해당 위치에 유닛이 배치된다
```
**상태: ✅ 완료**

### AC-FRM-03: 중복 방지
```
GIVEN 이미 배치된 장수가 있을 때
WHEN 같은 장수를 다른 위치에 배치하면
THEN 배치가 실패한다
```
**상태: ✅ 완료**

### AC-FRM-04: 위치 스왑
```
GIVEN 두 위치에 유닛이 있을 때
WHEN 한 유닛을 다른 유닛 위치로 이동하면
THEN 두 유닛의 위치가 교환된다
```
**상태: ✅ 완료**

### AC-FRM-05: 세력 시너지
```
GIVEN 같은 세력 3명이 배치되었을 때
WHEN 시너지를 계산하면
THEN 공격력 +10% 보너스가 적용된다
```
**상태: ✅ 완료**

### AC-FRM-06: 클래스 시너지
```
GIVEN 같은 클래스 3명이 배치되었을 때
WHEN 시너지를 계산하면
THEN 클래스 보너스 +10%가 적용된다
```
**상태: ✅ 완료**

### AC-FRM-07: 진형 저장
```
GIVEN 진형이 설정되었을 때
WHEN 저장 버튼을 누르면
THEN DB/LocalStorage에 진형이 저장된다
```
**상태: ✅ 완료** (FormationManager를 통한 5슬롯 저장)

### AC-FRM-08: 진형 UI
```
GIVEN 진형 편집 화면에서
WHEN 장수를 클릭/선택하면
THEN 그리드 위치에 배치할 수 있다
```
**상태: ✅ 완료** (클릭 기반 배치)

### AC-FRM-09: 전투 연동
```
GIVEN 진형이 설정되었을 때
WHEN 전투를 시작하면
THEN Formation 데이터가 BattleManager에 전달된다
```
**상태: ✅ 완료** (선택된 슬롯의 진형 사용)

### AC-FRM-10: 클래스 배치 권장
```
GIVEN 클래스별 권장 위치가 있을 때
WHEN 권장 위치가 아닌 곳에 배치하면
THEN 경고 메시지가 표시된다 (배치는 허용)
```
**상태: ❌ 미구현**

### AC-FRM-11: 다중 진형 슬롯
```
GIVEN 5개의 진형 슬롯이 있을 때
WHEN 슬롯을 선택하면
THEN 해당 슬롯의 진형이 표시된다
```
**상태: ✅ 완료**

### AC-FRM-12: 슬롯 이름 변경
```
GIVEN 진형 슬롯이 있을 때
WHEN 이름 편집 버튼을 누르면
THEN 슬롯 이름을 변경할 수 있다
```
**상태: ✅ 완료**

### AC-FRM-13: 출전 슬롯 선택
```
GIVEN 스테이지 선택 화면에서
WHEN 진형 슬롯을 선택하면
THEN 해당 슬롯의 진형으로 전투에 참여한다
```
**상태: ✅ 완료**

---

## 4. 다음 구현 우선순위

1. **진형 UI** - FormationScene 추가, 드래그앤드롭
2. **DB 저장** - Supabase formations 테이블 연동
3. **BattleManager 연동** - Formation → BattleUnit 변환
4. **다중 슬롯** - 최대 5개 진형 프리셋
5. **시너지 상세화** - 2/3/4/5명 단계별 보너스 테이블
6. **클래스 배치 가이드** - 권장 위치 하이라이트

---

## 5. 데이터 구조

### Position 인터페이스
```typescript
interface Position {
  row: number;    // 0=전열, 1=중열, 2=후열
  col: number;    // 0=좌, 1=중, 2=우
  generalId: string;
}
```

### FormationJSON 인터페이스
```typescript
interface FormationJSON {
  userId: string;
  positions: Position[];
}
```

### DB 스키마 (formations 테이블)
```typescript
{
  id: string;
  user_id: string;
  slot: number;           // 0-4 (최대 5슬롯)
  positions: (string | null)[];  // 9칸 배열
  is_active: boolean;
}
```
