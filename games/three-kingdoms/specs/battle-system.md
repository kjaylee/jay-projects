# 전투 시스템 스펙 (Battle System)

## 1. 현재 구현 상태

### ✅ 완료된 기능

#### BattleManager (`src/managers/BattleManager.ts`)
- **전투 상태 관리**
  - `BattleState`: IDLE → PREPARING → FIGHTING → VICTORY/DEFEAT
  - `startBattle()`: 전투 시작
  - `update(delta)`: 프레임 업데이트

- **유닛 관리**
  - `allyUnits`, `enemyUnits` 배열
  - 샘플 데이터: 관우, 장비, 조운 vs 황건적 x3
  - 유닛 속성: id, name, hp, maxHp, attack, defense, speed

- **턴 시스템**
  - `turnInterval`: 2000ms (2초마다 턴)
  - 속도순 행동 정렬
  - 배속 지원 (1x, 2x, 4x)

#### 데미지 계산 (`tests/unit/DamageCalculator.test.ts`)
- **물리 데미지 공식**: `ATK * (1 - DEF/(DEF+100))`
  - DEF 0: 100% 데미지
  - DEF 100: 50% 데미지
  - DEF 200: 33% 데미지

- **계략 데미지 공식**: `INT * multiplier * (1 - RES/(RES+80))`
  - RES 0: 100% 데미지
  - RES 80: 50% 데미지

#### 전투 로직 (`tests/unit/BattleSystem.test.ts`)
- `sortBySpeed()`: 속도순 정렬
- `applyDamage()`: 데미지 적용 (immutable)
- `isUnitAlive()`: 생존 여부
- `calculateDamage()`: 데미지 계산

#### BattleScene (`src/scenes/BattleScene.ts`)
- 전투 UI 레이아웃
- 3x3 그리드 진형 표시 (아군/적군)
- 유닛 이모지 표시 (🗡️, 🛡️, 🏹, 👹, 👺, 💀)
- HP 바 표시
- 배속 버튼 (1x/2x/4x)
- 데미지 텍스트 애니메이션
- 승/패 결과 표시

### 🧪 테스트 커버리지
- [x] 속도순 행동 정렬
- [x] 데미지 적용 (immutable)
- [x] HP 0 이하 방지
- [x] 생존 여부 판정
- [x] 물리 데미지 공식 검증
- [x] 계략 데미지 공식 검증

---

## 2. 남은 요구사항

### ❌ 미구현 기능

| 기능 | 기획서 요구사항 | 상태 |
|------|----------------|------|
| **진형 연동** | Formation 엔티티와 BattleManager 연결 | 하드코딩됨 |
| **전열 우선 타겟** | 전열 → 중열 → 후열 순 타겟팅 | 단순 배열 인덱스 사용 |
| **계략 발동** | 게이지 충전 시 발동 | 미구현 |
| **스킬 시스템 연동** | Skill 엔티티 적용 | 미구현 |
| **버프/디버프** | 턴 기반 지속 효과 | 미구현 |
| **병력 시스템** | 병력 0 → 장수 퇴장 | HP로 대체 |
| **턴 제한** | 턴 초과 시 승패 판정 | 미구현 |
| **전투 리플레이** | 전투 기록 저장/재생 | DB 스키마만 존재 |
| **스테이지 데이터** | 적군 구성, 보상 정보 | 미구현 |

### 📋 기획서 전투 진행 흐름

```
1. 양측 진형 배치 ❌ (Formation 미연동)
2. 턴 시작 → 속도순 행동 ✅
3. 일반 공격 (전열 우선 타겟) ⚠️ (우선순위 미구현)
4. 계략 발동 (게이지 충전 시) ❌
5. 병력 0 → 장수 퇴장 ✅ (HP로 대체)
6. 전멸 또는 턴 제한 → 승패 판정 ⚠️ (턴 제한 없음)
```

---

## 3. 수용 기준 (Acceptance Criteria)

### AC-BTL-01: 전투 시작
```
GIVEN 아군 진형과 적군 스테이지가 설정되었을 때
WHEN 전투를 시작하면
THEN 양측 유닛이 배치되고 FIGHTING 상태로 전환된다
```
**상태: ⚠️ 부분 구현** (하드코딩된 유닛)

### AC-BTL-02: 속도순 행동
```
GIVEN 전투 중인 유닛들이 있을 때
WHEN 턴이 시작되면
THEN 속도가 높은 유닛부터 순서대로 행동한다
```
**상태: ✅ 완료**

### AC-BTL-03: 전열 우선 타겟팅
```
GIVEN 적군이 전열/중열/후열에 배치되었을 때
WHEN 일반 공격을 수행하면
THEN 전열 → 중열 → 후열 순으로 타겟을 선택한다
```
**상태: ❌ 미구현**

### AC-BTL-04: 데미지 계산
```
GIVEN 공격자 ATK, 방어자 DEF일 때
WHEN 물리 공격을 수행하면
THEN ATK * (1 - DEF/(DEF+100)) 데미지가 적용된다
```
**상태: ✅ 완료**

### AC-BTL-05: 계략 발동
```
GIVEN 장수가 계략(스킬)을 보유하고 있을 때
WHEN 쿨다운이 0이고 게이지가 충분하면
THEN 계략이 발동되어 효과가 적용된다
```
**상태: ❌ 미구현**

### AC-BTL-06: 버프/디버프
```
GIVEN 버프/디버프 효과가 있을 때
WHEN 턴이 진행되면
THEN 지속 시간이 1 감소하고 효과가 유지된다
```
**상태: ❌ 미구현**

### AC-BTL-07: 승리 조건
```
GIVEN 전투 중일 때
WHEN 적군이 전멸하면
THEN VICTORY 상태로 전환되고 보상이 지급된다
```
**상태: ⚠️ 부분 구현** (보상 미구현)

### AC-BTL-08: 패배 조건
```
GIVEN 전투 중일 때
WHEN 아군이 전멸하면
THEN DEFEAT 상태로 전환된다
```
**상태: ✅ 완료**

### AC-BTL-09: 배속 조절
```
GIVEN 전투 중일 때
WHEN 배속 버튼을 클릭하면
THEN 전투 속도가 1x → 2x → 4x → 1x 순환한다
```
**상태: ✅ 완료**

### AC-BTL-10: 전투 리플레이
```
GIVEN 전투가 종료되었을 때
WHEN 리플레이를 저장하면
THEN 모든 행동 기록이 DB에 저장되어 재생 가능하다
```
**상태: ❌ 미구현** (DB 스키마만 존재)

---

## 4. 다음 구현 우선순위

1. **Formation 연동** - BattleManager가 Formation 엔티티 사용
2. **전열 우선 타겟팅** - 행(row) 기반 타겟 선택
3. **스킬/계략 시스템** - Skill 엔티티와 전투 연동
4. **버프/디버프 매니저** - 지속 효과 관리
5. **스테이지 데이터** - 적군 구성, 보상 정보 JSON/DB
6. **전투 리플레이** - 행동 기록 및 재생

---

## 5. 기술 부채

- `BattleManager.initUnits()`: 하드코딩된 샘플 유닛 → Formation/General 연동 필요
- `BattleScene.createUnits()`: 하드코딩된 이모지 → 실제 장수 데이터 연동 필요
- HP 바 업데이트 로직 누락 (현재 정적)
- 데미지 계산 로직이 테스트 파일에만 존재 → 공용 모듈로 분리 필요
