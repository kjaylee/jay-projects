<!DOCTYPE html>
<html lang="ko">
<head>
    <script data-goatcounter="https://jaygames.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üé£ ÎÇöÏãú ÌÉÄÏù¥Ïø§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(180deg, #87CEEB 0%, #1E90FF 100%);
            min-height: 100vh;
            overflow: hidden;
        }
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 500px;
            margin: 0 auto;
        }
        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        .ui-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
            z-index: 10;
        }
        .stat-box {
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 14px;
            pointer-events: auto;
        }
        .btn {
            background: linear-gradient(180deg, #FFD700 0%, #FFA500 100%);
            border: 2px solid #8B4513;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
            color: #4a2c00;
            cursor: pointer;
            pointer-events: auto;
            transition: transform 0.1s;
        }
        .btn:active {
            transform: scale(0.95);
        }
        .modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(180deg, #FFF8DC 0%, #FAEBD7 100%);
            border: 4px solid #8B4513;
            border-radius: 20px;
            padding: 20px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            z-index: 100;
        }
        .modal.active { display: block; }
        .modal-backdrop {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
        }
        .modal-backdrop.active { display: block; }
        .modal h2 {
            text-align: center;
            color: #4a2c00;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .fish-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .fish-item {
            background: rgba(139,69,19,0.2);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            font-size: 12px;
        }
        .fish-item .emoji {
            font-size: 30px;
            display: block;
            margin-bottom: 5px;
        }
        .fish-item.locked .emoji {
            filter: grayscale(1) brightness(0.3);
        }
        .shop-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(139,69,19,0.15);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .shop-item-info {
            flex: 1;
        }
        .shop-item-name {
            font-weight: bold;
            color: #4a2c00;
        }
        .shop-item-desc {
            font-size: 12px;
            color: #666;
        }
        .shop-btn {
            background: linear-gradient(180deg, #90EE90 0%, #32CD32 100%);
            border: 2px solid #228B22;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }
        .shop-btn:disabled {
            background: #ccc;
            border-color: #999;
            cursor: not-allowed;
        }
        .shop-btn.owned {
            background: linear-gradient(180deg, #87CEEB 0%, #4682B4 100%);
            border-color: #2F4F4F;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
        }
        .instruction {
            position: absolute;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 16px;
            text-align: center;
            pointer-events: none;
            z-index: 5;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.8; transform: translateX(-50%) scale(1.02); }
        }
        .catch-popup {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(180deg, #FFE4B5 0%, #FFD700 100%);
            border: 4px solid #DAA520;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            z-index: 50;
            animation: popIn 0.3s ease-out;
        }
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        .catch-popup .emoji {
            font-size: 60px;
        }
        .catch-popup .name {
            font-size: 24px;
            font-weight: bold;
            color: #4a2c00;
            margin: 10px 0;
        }
        .catch-popup .price {
            font-size: 18px;
            color: #228B22;
        }
        .catch-popup .rarity {
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 5px;
        }
        .rarity-common { background: #90EE90; }
        .rarity-uncommon { background: #87CEEB; }
        .rarity-rare { background: #DDA0DD; }
        .rarity-epic { background: #FFD700; }
        .rarity-legendary { background: #FF6347; color: white; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div class="ui-overlay">
            <div class="stat-box">
                üí∞ <span id="money">0</span>Ïõê
            </div>
            <div style="display: flex; gap: 5px;">
                <button class="btn" onclick="openModal('collection')">üìñ ÎèÑÍ∞ê</button>
                <button class="btn" onclick="openModal('shop')">üõí ÏÉÅÏ†ê</button>
            </div>
        </div>
        
        <div id="instruction" class="instruction"></div>
        
        <div id="catchPopup" class="catch-popup" style="display:none;"></div>
        
        <div id="modalBackdrop" class="modal-backdrop" onclick="closeModal()"></div>
        
        <div id="collectionModal" class="modal">
            <button class="close-btn" onclick="closeModal()">‚úï</button>
            <h2>üìñ Î¨ºÍ≥†Í∏∞ ÎèÑÍ∞ê</h2>
            <div id="fishGrid" class="fish-grid"></div>
        </div>
        
        <div id="shopModal" class="modal">
            <button class="close-btn" onclick="closeModal()">‚úï</button>
            <h2>üõí ÎÇöÏãØÎåÄ ÏÉÅÏ†ê</h2>
            <div id="shopList"></div>
        </div>
    </div>

    <script>
        // ==================== Í≤åÏûÑ ÏÉÅÏàò ====================
        const FISH_DATA = [
            { id: 1, name: 'Î∂ïÏñ¥', emoji: 'üêü', price: 50, rarity: 'common', weight: 40 },
            { id: 2, name: 'ÏûâÏñ¥', emoji: 'üêü', price: 80, rarity: 'common', weight: 30 },
            { id: 3, name: 'Í∏àÎ∂ïÏñ¥', emoji: 'üê†', price: 150, rarity: 'uncommon', weight: 15 },
            { id: 4, name: 'Ïó¥ÎåÄÏñ¥', emoji: 'üê†', price: 200, rarity: 'uncommon', weight: 10 },
            { id: 5, name: 'Î≥µÏñ¥', emoji: 'üê°', price: 300, rarity: 'rare', weight: 5 },
            { id: 6, name: 'Ìï¥ÌååÎ¶¨', emoji: 'ü™º', price: 250, rarity: 'rare', weight: 6 },
            { id: 7, name: 'Î¨∏Ïñ¥', emoji: 'üêô', price: 400, rarity: 'rare', weight: 4 },
            { id: 8, name: 'Ïò§ÏßïÏñ¥', emoji: 'ü¶ë', price: 350, rarity: 'rare', weight: 5 },
            { id: 9, name: 'ÎèåÍ≥†Îûò', emoji: 'üê¨', price: 800, rarity: 'epic', weight: 2 },
            { id: 10, name: 'Í≥†Îûò', emoji: 'üêã', price: 1500, rarity: 'epic', weight: 1 },
            { id: 11, name: 'ÏÉÅÏñ¥', emoji: 'ü¶à', price: 2000, rarity: 'legendary', weight: 0.5 },
            { id: 12, name: 'Î≤îÍ≥†Îûò', emoji: 'üê≥', price: 3000, rarity: 'legendary', weight: 0.3 },
        ];

        const ROD_DATA = [
            { id: 1, name: 'ÎÇòÎ¨¥ ÎÇöÏãØÎåÄ', desc: 'Í∏∞Î≥∏ ÎÇöÏãØÎåÄ', price: 0, catchBonus: 1, speedBonus: 1 },
            { id: 2, name: 'ÎåÄÎÇòÎ¨¥ ÎÇöÏãØÎåÄ', desc: 'ÏÜçÎèÑ 10% Ï¶ùÍ∞Ä', price: 500, catchBonus: 1, speedBonus: 1.1 },
            { id: 3, name: 'Ïπ¥Î≥∏ ÎÇöÏãØÎåÄ', desc: 'Ìù¨Í∑Ä ÌôïÎ•† 20% Ï¶ùÍ∞Ä', price: 1500, catchBonus: 1.2, speedBonus: 1.15 },
            { id: 4, name: 'Ìã∞ÌÉÄÎäÑ ÎÇöÏãØÎåÄ', desc: 'Ìù¨Í∑Ä ÌôïÎ•† 50% Ï¶ùÍ∞Ä', price: 4000, catchBonus: 1.5, speedBonus: 1.2 },
            { id: 5, name: 'Ìô©Í∏à ÎÇöÏãØÎåÄ', desc: 'Ìù¨Í∑Ä ÌôïÎ•† 100% Ï¶ùÍ∞Ä', price: 10000, catchBonus: 2, speedBonus: 1.3 },
            { id: 6, name: 'Ï†ÑÏÑ§Ïùò ÎÇöÏãØÎåÄ', desc: 'Ï†ÑÏÑ§ Î¨ºÍ≥†Í∏∞ ÌôïÎ•† UP!', price: 30000, catchBonus: 3, speedBonus: 1.5 },
        ];

        const RARITY_NAMES = {
            common: 'ÏùºÎ∞ò',
            uncommon: 'Í≥†Í∏â',
            rare: 'Ìù¨Í∑Ä',
            epic: 'ÏòÅÏõÖ',
            legendary: 'Ï†ÑÏÑ§'
        };

        // ==================== Í≤åÏûÑ ÏÉÅÌÉú ====================
        let gameState = {
            money: 0,
            currentRod: 1,
            ownedRods: [1],
            collection: [],
            phase: 'idle', // idle, casting, waiting, biting, reeling, caught
            bobberX: 0,
            bobberY: 0,
            hookDepth: 0,
            biteTimer: 0,
            reelProgress: 0,
            currentFish: null,
            missTimer: 0,
        };

        // ==================== Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resize() {
            const container = document.getElementById('gameContainer');
            width = canvas.width = container.clientWidth;
            height = canvas.height = container.clientHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // ==================== Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞ ====================
        function saveGame() {
            localStorage.setItem('fishingTycoon', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('fishingTycoon');
            if (saved) {
                const parsed = JSON.parse(saved);
                gameState = { ...gameState, ...parsed };
            }
            updateUI();
        }

        // ==================== Î¨ºÍ≥†Í∏∞ ÏÑ†ÌÉù ====================
        function selectFish() {
            const rod = ROD_DATA.find(r => r.id === gameState.currentRod);
            const bonus = rod ? rod.catchBonus : 1;
            
            // Í∞ÄÏ§ëÏπò Í≥ÑÏÇ∞
            let totalWeight = 0;
            const weights = FISH_DATA.map(fish => {
                let w = fish.weight;
                if (fish.rarity === 'rare' || fish.rarity === 'epic' || fish.rarity === 'legendary') {
                    w *= bonus;
                }
                totalWeight += w;
                return w;
            });
            
            // ÎûúÎç§ ÏÑ†ÌÉù
            let rand = Math.random() * totalWeight;
            for (let i = 0; i < FISH_DATA.length; i++) {
                rand -= weights[i];
                if (rand <= 0) return FISH_DATA[i];
            }
            return FISH_DATA[0];
        }

        // ==================== Í≤åÏûÑ Î°úÏßÅ ====================
        function startCasting(x, y) {
            if (gameState.phase !== 'idle') return;
            
            gameState.phase = 'casting';
            gameState.bobberX = x;
            gameState.bobberY = height * 0.52; // Î¨º ÌëúÎ©¥(0.5) Î∞îÎ°ú ÏïÑÎûòÏóê Ï∞å Î∞∞Ïπò
            gameState.hookDepth = 0;
            
            setTimeout(() => {
                if (gameState.phase === 'casting') {
                    gameState.phase = 'waiting';
                    const rod = ROD_DATA.find(r => r.id === gameState.currentRod);
                    const speedBonus = rod ? rod.speedBonus : 1;
                    const waitTime = (2000 + Math.random() * 4000) / speedBonus;
                    
                    setTimeout(() => {
                        if (gameState.phase === 'waiting') {
                            gameState.phase = 'biting';
                            gameState.currentFish = selectFish();
                            gameState.biteTimer = 0;
                            gameState.missTimer = 1500 + Math.random() * 1000;
                        }
                    }, waitTime);
                }
            }, 500);
            
            updateInstruction();
        }

        function tryReel() {
            if (gameState.phase === 'biting') {
                gameState.phase = 'reeling';
                gameState.reelProgress = 0;
                updateInstruction();
            } else if (gameState.phase === 'waiting') {
                // ÎÑàÎ¨¥ Îπ®Î¶¨ ÎãπÍπÄ - Ïã§Ìå®
                resetToIdle();
            } else if (gameState.phase === 'reeling') {
                // Î¶¥ ÎãπÍ∏∞Í∏∞
                gameState.reelProgress += 15 + Math.random() * 10;
                if (gameState.reelProgress >= 100) {
                    catchFish();
                }
            }
        }

        function catchFish() {
            gameState.phase = 'caught';
            const fish = gameState.currentFish;
            
            // Ïª¨Î†âÏÖòÏóê Ï∂îÍ∞Ä
            if (!gameState.collection.includes(fish.id)) {
                gameState.collection.push(fish.id);
            }
            
            // Îèà Ï∂îÍ∞Ä
            gameState.money += fish.price;
            
            // ÌåùÏóÖ ÌëúÏãú
            showCatchPopup(fish);
            
            saveGame();
            updateUI();
            
            setTimeout(() => {
                hideCatchPopup();
                resetToIdle();
            }, 2000);
        }

        function resetToIdle() {
            gameState.phase = 'idle';
            gameState.currentFish = null;
            gameState.reelProgress = 0;
            updateInstruction();
        }

        function showCatchPopup(fish) {
            const popup = document.getElementById('catchPopup');
            popup.innerHTML = `
                <div class="emoji">${fish.emoji}</div>
                <div class="name">${fish.name}</div>
                <div class="price">+${fish.price}Ïõê</div>
                <div class="rarity rarity-${fish.rarity}">${RARITY_NAMES[fish.rarity]}</div>
            `;
            popup.style.display = 'block';
        }

        function hideCatchPopup() {
            document.getElementById('catchPopup').style.display = 'none';
        }

        // ==================== UI ÏóÖÎç∞Ïù¥Ìä∏ ====================
        function updateUI() {
            document.getElementById('money').textContent = gameState.money.toLocaleString();
        }

        function updateInstruction() {
            const el = document.getElementById('instruction');
            switch (gameState.phase) {
                case 'idle':
                    el.textContent = 'üé£ ÌÑ∞ÏπòÌï¥ÏÑú Ï∫êÏä§ÌåÖÌïòÏÑ∏Ïöî!';
                    el.style.display = 'block';
                    break;
                case 'casting':
                    el.style.display = 'none';
                    break;
                case 'waiting':
                    el.textContent = '‚è≥ Î¨ºÍ≥†Í∏∞Î•º Í∏∞Îã§Î¶¨Îäî Ï§ë...';
                    el.style.display = 'block';
                    break;
                case 'biting':
                    el.textContent = 'üîî ÏßÄÍ∏àÏù¥Îã§! ÌÑ∞Ïπò!';
                    el.style.display = 'block';
                    break;
                case 'reeling':
                    el.textContent = 'üí™ Í≥ÑÏÜç ÌÑ∞ÏπòÌï¥ÏÑú ÎãπÍ≤®!';
                    el.style.display = 'block';
                    break;
                default:
                    el.style.display = 'none';
            }
        }

        // ==================== Î™®Îã¨ ====================
        function openModal(type) {
            document.getElementById('modalBackdrop').classList.add('active');
            
            if (type === 'collection') {
                renderCollection();
                document.getElementById('collectionModal').classList.add('active');
            } else if (type === 'shop') {
                renderShop();
                document.getElementById('shopModal').classList.add('active');
            }
        }

        function closeModal() {
            document.getElementById('modalBackdrop').classList.remove('active');
            document.getElementById('collectionModal').classList.remove('active');
            document.getElementById('shopModal').classList.remove('active');
        }

        function renderCollection() {
            const grid = document.getElementById('fishGrid');
            grid.innerHTML = FISH_DATA.map(fish => {
                const unlocked = gameState.collection.includes(fish.id);
                return `
                    <div class="fish-item ${unlocked ? '' : 'locked'}">
                        <span class="emoji">${fish.emoji}</span>
                        <div>${unlocked ? fish.name : '???'}</div>
                        <div style="font-size:10px;color:#888;">${unlocked ? fish.price + 'Ïõê' : ''}</div>
                    </div>
                `;
            }).join('');
        }

        function renderShop() {
            const list = document.getElementById('shopList');
            list.innerHTML = ROD_DATA.map(rod => {
                const owned = gameState.ownedRods.includes(rod.id);
                const equipped = gameState.currentRod === rod.id;
                const canBuy = gameState.money >= rod.price;
                
                let btnText = owned ? (equipped ? '‚úì Ïû•Ï∞©Îê®' : 'Ïû•Ï∞©ÌïòÍ∏∞') : `${rod.price.toLocaleString()}Ïõê`;
                let btnClass = owned ? 'shop-btn owned' : 'shop-btn';
                let disabled = !owned && !canBuy;
                
                return `
                    <div class="shop-item">
                        <div class="shop-item-info">
                            <div class="shop-item-name">üé£ ${rod.name}</div>
                            <div class="shop-item-desc">${rod.desc}</div>
                        </div>
                        <button class="${btnClass}" ${disabled ? 'disabled' : ''} onclick="shopAction(${rod.id})">
                            ${btnText}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function shopAction(rodId) {
            const rod = ROD_DATA.find(r => r.id === rodId);
            if (!rod) return;
            
            if (gameState.ownedRods.includes(rodId)) {
                // Ïû•Ï∞©
                gameState.currentRod = rodId;
            } else if (gameState.money >= rod.price) {
                // Íµ¨Îß§
                gameState.money -= rod.price;
                gameState.ownedRods.push(rodId);
                gameState.currentRod = rodId;
            }
            
            saveGame();
            updateUI();
            renderShop();
        }

        // ==================== Í∑∏Î¶¨Í∏∞ ====================
        let waveOffset = 0;

        function draw() {
            ctx.clearRect(0, 0, width, height);
            
            // ÌïòÎäò
            const skyGrad = ctx.createLinearGradient(0, 0, 0, height * 0.5);
            skyGrad.addColorStop(0, '#87CEEB');
            skyGrad.addColorStop(1, '#1E90FF');
            ctx.fillStyle = skyGrad;
            ctx.fillRect(0, 0, width, height * 0.5);
            
            // ÌÉúÏñë
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(width * 0.85, height * 0.12, 35, 0, Math.PI * 2);
            ctx.fill();
            
            // Íµ¨Î¶Ñ
            drawCloud(width * 0.2, height * 0.1, 0.8);
            drawCloud(width * 0.6, height * 0.15, 1);
            
            // Î¨º (ÌååÎèÑ)
            const waterY = height * 0.5;
            ctx.fillStyle = '#1E90FF';
            ctx.beginPath();
            ctx.moveTo(0, waterY);
            for (let x = 0; x <= width; x += 10) {
                const y = waterY + Math.sin((x + waveOffset) * 0.02) * 8;
                ctx.lineTo(x, y);
            }
            ctx.lineTo(width, height);
            ctx.lineTo(0, height);
            ctx.closePath();
            ctx.fill();
            
            // Î¨º ÏÜç Í∑∏ÎùºÎç∞Ïù¥ÏÖò
            const waterGrad = ctx.createLinearGradient(0, waterY, 0, height);
            waterGrad.addColorStop(0, 'rgba(0,100,180,0.3)');
            waterGrad.addColorStop(1, 'rgba(0,50,100,0.8)');
            ctx.fillStyle = waterGrad;
            ctx.fillRect(0, waterY + 10, width, height - waterY);
            
            // ÎÇöÏãúÍæº (ÌôîÎ©¥ ÌïòÎã®)
            drawFisherman();
            
            // ÎÇöÏãØÏ§ÑÍ≥º Ï∞å
            if (gameState.phase !== 'idle') {
                drawFishingLine();
            }
            
            // Î¨ºÍ≥†Í∏∞ Ïï†ÎãàÎ©îÏù¥ÏÖò (Î¨ºÏÜç)
            drawSwimmingFish();
            
            waveOffset += 2;
        }

        function drawCloud(x, y, scale) {
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.beginPath();
            ctx.arc(x, y, 20 * scale, 0, Math.PI * 2);
            ctx.arc(x + 25 * scale, y - 5 * scale, 25 * scale, 0, Math.PI * 2);
            ctx.arc(x + 50 * scale, y, 20 * scale, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawFisherman() {
            const x = width * 0.15;
            const y = height * 0.85;
            
            // Î™∏
            ctx.fillStyle = '#4a4a4a';
            ctx.fillRect(x - 15, y - 40, 30, 50);
            
            // Î®∏Î¶¨
            ctx.fillStyle = '#FFE4C4';
            ctx.beginPath();
            ctx.arc(x, y - 55, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Î™®Ïûê
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(x - 20, y - 75, 40, 10);
            ctx.fillRect(x - 12, y - 85, 24, 15);
            
            // ÎÇöÏãØÎåÄ
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(x + 10, y - 30);
            ctx.lineTo(x + 80, y - 100);
            ctx.stroke();
        }

        function drawFishingLine() {
            const rodTipX = width * 0.15 + 80;
            const rodTipY = height * 0.85 - 100;
            
            // ÎÇöÏãØÏ§Ñ
            ctx.strokeStyle = 'rgba(255,255,255,0.6)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(rodTipX, rodTipY);
            ctx.lineTo(gameState.bobberX, gameState.bobberY);
            ctx.stroke();
            
            // Î¨ºÏÜç Ï§Ñ
            if (gameState.phase !== 'casting') {
                ctx.beginPath();
                ctx.moveTo(gameState.bobberX, gameState.bobberY);
                ctx.lineTo(gameState.bobberX, gameState.bobberY + 50 + gameState.hookDepth);
                ctx.stroke();
            }
            
            // Ï∞å
            const bobberY = gameState.bobberY + (gameState.phase === 'biting' ? Math.sin(Date.now() * 0.03) * 10 : 0);
            
            ctx.fillStyle = '#FF4500';
            ctx.beginPath();
            ctx.ellipse(gameState.bobberX, bobberY, 8, 12, 0, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.ellipse(gameState.bobberX, bobberY - 6, 8, 6, 0, 0, Math.PI);
            ctx.fill();
            
            // Î¶¥ÎßÅ ÏßÑÌñâ ÌëúÏãú
            if (gameState.phase === 'reeling') {
                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.fillRect(width * 0.2, height * 0.6, width * 0.6, 20);
                ctx.fillStyle = '#32CD32';
                ctx.fillRect(width * 0.2, height * 0.6, width * 0.6 * (gameState.reelProgress / 100), 20);
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.strokeRect(width * 0.2, height * 0.6, width * 0.6, 20);
            }
        }

        let bgFish = [];
        function initBgFish() {
            for (let i = 0; i < 8; i++) {
                bgFish.push({
                    x: Math.random() * width,
                    y: height * 0.55 + Math.random() * height * 0.35,
                    speed: 0.5 + Math.random() * 1.5,
                    emoji: ['üêü', 'üê†', 'üê°'][Math.floor(Math.random() * 3)],
                    size: 15 + Math.random() * 15,
                    dir: Math.random() > 0.5 ? 1 : -1
                });
            }
        }

        function drawSwimmingFish() {
            bgFish.forEach(fish => {
                ctx.save();
                ctx.font = `${fish.size}px serif`;
                ctx.scale(fish.dir, 1);
                ctx.fillText(fish.emoji, fish.x * fish.dir, fish.y);
                ctx.restore();
                
                fish.x += fish.speed * fish.dir;
                if (fish.x > width + 30) fish.x = -30;
                if (fish.x < -30) fish.x = width + 30;
            });
        }

        // ==================== ÏûÖÎ†• Ï≤òÎ¶¨ ====================
        function handleInput(x, y) {
            if (gameState.phase === 'idle') {
                // Î¨º ÏúÑÏóê Ï∫êÏä§ÌåÖ
                if (y > height * 0.5 && y < height * 0.75) {
                    startCasting(x, y);
                }
            } else if (gameState.phase === 'biting' || gameState.phase === 'reeling') {
                tryReel();
            } else if (gameState.phase === 'waiting') {
                // ÎÑàÎ¨¥ ÏùºÏ∞ç ÎãπÍ∏∞Î©¥ Ïã§Ìå®
                resetToIdle();
            }
        }

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (width / rect.width);
            const y = (e.clientY - rect.top) * (height / rect.height);
            handleInput(x, y);
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = (touch.clientX - rect.left) * (width / rect.width);
            const y = (touch.clientY - rect.top) * (height / rect.height);
            handleInput(x, y);
        }, { passive: false });

        // ==================== Í≤åÏûÑ Î£®ÌîÑ ====================
        function gameLoop() {
            // Î¨ºÍ≥†Í∏∞Í∞Ä Î¨ºÏóàÏùÑ Îïå ÌÉÄÏù¥Î®∏
            if (gameState.phase === 'biting') {
                gameState.missTimer -= 16;
                if (gameState.missTimer <= 0) {
                    // ÎÜìÏπ®
                    resetToIdle();
                }
            }
            
            // Î¨ºÏÜçÏóêÏÑú ÌõÖÏù¥ ÎÇ¥Î†§Í∞ê
            if (gameState.phase === 'waiting' || gameState.phase === 'biting') {
                if (gameState.hookDepth < 80) {
                    gameState.hookDepth += 1;
                }
            }
            
            draw();
            requestAnimationFrame(gameLoop);
        }

        // ==================== Ï¥àÍ∏∞Ìôî ====================
        loadGame();
        initBgFish();
        updateInstruction();
        gameLoop();
    </script>
</body>
</html>
